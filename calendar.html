<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Soñora Kalender</title>
<style>
:root{
  --bg:#FBF5E9;
  --accent:#F3814B;
  --text:#122F4D;
  --muted:#6b7b8a;
  --disabled:#f7b4b4;
  --range:#FFE5D1;
}
body{
  margin:0;
  background:var(--bg);
  font-family:Poppins,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  color:var(--text);
  padding:20px;
}

/* Container */
.cal-card{
  background:white;
  border-radius:12px;
  box-shadow:0 2px 8px rgba(0,0,0,.08);
  padding:20px;
  max-width:800px;
  margin:auto;
}

/* Titel */
h2{
  margin-top:0;
  color:var(--accent);
}

/* Navigatie */
.cal-header{
  display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;
}
button{
  background:var(--accent);
  color:#fff;
  border:none;
  padding:8px 12px;
  border-radius:8px;
  cursor:pointer;
  font-weight:600;
}
button:hover{filter:brightness(.95)}

/* Maanden */
.months{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:20px;
}
@media(max-width:700px){
  .months{grid-template-columns:1fr;}
}

/* Maandweergave */
.month h4{margin:8px 0;color:var(--accent)}
.grid-7{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;text-align:center;}
.dow{font-weight:600;color:var(--muted);font-size:.9rem;}
.day{
  background:#fff7eb;
  border-radius:8px;
  padding:8px 0;
  cursor:pointer;
  user-select:none;
}
.day.empty{background:transparent;cursor:default;}
.day.booked{background:var(--disabled)!important;color:#8a0000!important;cursor:not-allowed;}
.day.selected{background:var(--accent)!important;color:#fff!important;}
.day.in-range{background:var(--range)!important;}
.day:hover:not(.booked):not(.empty){filter:brightness(.95);}
.hint{margin-top:10px;color:var(--muted);font-size:.9rem;text-align:center;}
</style>
</head>
<body>

<div class="cal-card">
  <h2>Beschikbaarheid</h2>
  <div class="cal-header">
    <button id="prevBtn">← Vorige</button>
    <div id="monthRange" style="font-weight:700;"></div>
    <button id="nextBtn">Volgende →</button>
  </div>

  <div class="months" id="months"></div>
  <div class="hint" id="hint">Minimaal verblijf: <b>5 nachten</b>. Kies eerst aankomst, daarna vertrek.</div>
</div>

<script>
const NIGHT_PRICE = 75;
const CLEANING = 90;
const TOURIST_TAX = 31.50;
const MIN_NIGHTS = 5;

/* ---------- BEZETTE DAGEN (handmatig + iCal) ---------- */
let blocked = [];

// Voorbeeld: vaste blokkeringen
for (let d = 22; d <= 31; d++) {
  blocked.push(`2025-12-${String(d).padStart(2, '0')}`);
}

// Voeg hier je iCal-feed toe
const ICAL_URL = "https://www.micazu.nl/calendar/50435.ics"; // vervang door jouw echte iCal-link

async function loadICal() {
  try {
    const res = await fetch(ICAL_URL);
    if (!res.ok) throw new Error("Kan iCal niet laden");
    const text = await res.text();

    // Parse DTSTART / DTEND
    const events = [...text.matchAll(/DTSTART(?:;VALUE=DATE)?:(\d{8})[\s\S]*?DTEND(?:;VALUE=DATE)?:(\d{8})/g)];
    for (const e of events) {
      const start = parseICalDate(e[1]);
      const end = parseICalDate(e[2]);
      const cur = new Date(start);
      while (cur < end) {
        const ds = formatDate(cur);
        if (!blocked.includes(ds)) blocked.push(ds);
        cur.setDate(cur.getDate() + 1);
      }
    }

    console.log(`iCal geladen (${blocked.length} dagen geblokkeerd)`);
    renderMonths(); // opnieuw tekenen zodra data geladen is
  } catch (err) {
    console.warn("Kon iCal niet laden:", err.message);
    renderMonths();
  }
}

function parseICalDate(str) {
  return new Date(
    parseInt(str.substr(0, 4)),
    parseInt(str.substr(4, 2)) - 1,
    parseInt(str.substr(6, 2))
  );
}
function formatDate(d) {
  return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, "0")}-${String(d.getDate()).padStart(2, "0")}`;
}

/* ---------- KALENDER RENDERING ---------- */
let baseMonth = new Date(2025,10,1); // start in november 2025
let checkIn=null, checkOut=null;

const monthsWrap=document.getElementById('months');
const monthRange=document.getElementById('monthRange');
const prevBtn=document.getElementById('prevBtn');
const nextBtn=document.getElementById('nextBtn');
const hint=document.getElementById('hint');

prevBtn.onclick=()=>{baseMonth.setMonth(baseMonth.getMonth()-1);renderMonths();};
nextBtn.onclick=()=>{baseMonth.setMonth(baseMonth.getMonth()+1);renderMonths();};

function renderMonths(){
  monthsWrap.innerHTML='';
  const m1=new Date(baseMonth.getFullYear(),baseMonth.getMonth(),1);
  const m2=new Date(baseMonth.getFullYear(),baseMonth.getMonth()+1,1);
  const names=["januari","februari","maart","april","mei","juni","juli","augustus","september","oktober","november","december"];
  monthRange.textContent=`${names[m1.getMonth()]} ${m1.getFullYear()} – ${names[m2.getMonth()]} ${m2.getFullYear()}`;
  [m1,m2].forEach(m=>monthsWrap.appendChild(renderMonth(m)));
  paintRange();
}
function renderMonth(first){
  const year=first.getFullYear(), month=first.getMonth();
  const daysInMonth=new Date(year,month+1,0).getDate();
  const firstDow=(new Date(year,month,1).getDay()+6)%7;
  const wrap=document.createElement('div');wrap.className='month';
  const names=["januari","februari","maart","april","mei","juni","juli","augustus","september","oktober","november","december"];
  const title=document.createElement('h4');title.textContent=`${names[month]} ${year}`;wrap.appendChild(title);
  const g=document.createElement('div');g.className='grid-7';
  ["ma","di","wo","do","vr","za","zo"].forEach(d=>{const el=document.createElement('div');el.className='dow';el.textContent=d;g.appendChild(el);});
  for(let i=0;i<firstDow;i++){const e=document.createElement('div');e.className='day empty';g.appendChild(e);}
  for(let d=1; d<=daysInMonth; d++){
    const ds=`${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const el=document.createElement('div');el.className='day';el.textContent=d;
    if(blocked.includes(ds)) el.classList.add('booked');
    el.onclick=()=>onPick(ds,el.classList.contains('booked'));
    g.appendChild(el);
  }
  wrap.appendChild(g);
  return wrap;
}

/* ---------- SELECTIE & LOGICA ---------- */
function onPick(ds,isBlocked){
  if(isBlocked) return;
  const d=new Date(ds);
  if(!checkIn || (checkIn && checkOut)){
    checkIn=d;checkOut=null;
    paintRange();
    hint.textContent=`Gekozen aankomst: ${fmt(d)}. Kies vertrekdatum.`;
  } else if(d>checkIn){
    const nights=diff(checkIn,d);
    if(nights<MIN_NIGHTS){alert(`Minimaal ${MIN_NIGHTS} nachten.`);return;}
    if(validRange(checkIn,d)){
      checkOut=d;paintRange();updateSummary();
    } else alert("Periode bevat bezette dagen.");
  }
}
function paintRange(){
  document.querySelectorAll('.day').forEach(day=>day.classList.remove('selected','in-range'));
  document.querySelectorAll('.day').forEach(day=>{
    if(day.classList.contains('empty')||day.classList.contains('booked')) return;
    const monthName=day.closest('.month').querySelector('h4').textContent.split(' ');
    const monthIndex=["januari","februari","maart","april","mei","juni","juli","augustus","september","oktober","november","december"].indexOf(monthName[0]);
    const year=parseInt(monthName[1]);
    const dateStr=`${year}-${String(monthIndex+1).padStart(2,'0')}-${String(day.textContent).padStart(2,'0')}`;
    const dt=new Date(dateStr);
    if(checkIn && sameDate(dt,checkIn)) day.classList.add('selected');
    if(checkOut && sameDate(dt,checkOut)) day.classList.add('selected');
    if(checkIn && checkOut && dt>checkIn && dt<checkOut) day.classList.add('in-range');
  });
}
function validRange(a,b){
  const cur=new Date(a);
  while(cur<b){
    const ds=formatDate(cur);
    if(blocked.includes(ds)) return false;
    cur.setDate(cur.getDate()+1);
  }
  return true;
}
function diff(a,b){return Math.round((b-a)/(1000*60*60*24));}
function sameDate(a,b){return a.getFullYear()===b.getFullYear()&&a.getMonth()===b.getMonth()&&a.getDate()===b.getDate();}
function fmt(d){return `${d.getDate()}-${d.getMonth()+1}-${d.getFullYear()}`;}
function updateSummary(){
  if(checkIn && checkOut){
    const nights=diff(checkIn,checkOut);
    const base=nights*NIGHT_PRICE;
    const total=base+CLEANING+TOURIST_TAX;
    parent.postMessage({type:"updateSummary", nights, total, checkIn:fmt(checkIn), checkOut:fmt(checkOut)}, "*");
  }
}

/* Start */
loadICal();
</script>
</body>
</html>
